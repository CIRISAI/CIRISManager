<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Settings Button Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-4">OAuth Settings Button Test Harness</h1>

        <!-- Test Agent Cards -->
        <div id="agents-list" class="space-y-4">
            <!-- This will be populated by JavaScript -->
        </div>

        <!-- OAuth Setup Modal (from index.html) -->
        <div id="oauth-setup-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-2">OAuth Setup Required</h2>
                    <p class="text-gray-600 mb-6">This agent needs OAuth configuration. Follow these steps to enable authentication:</p>

                    <!-- Agent Info -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="text-sm text-gray-500">Agent ID:</span>
                                <span id="oauth-agent-id" class="font-mono font-bold ml-2">agent-name</span>
                            </div>
                            <div>
                                <span class="text-sm text-gray-500">Status:</span>
                                <span id="oauth-status" class="ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm">Pending Setup</span>
                            </div>
                        </div>
                    </div>

                    <!-- OAuth Providers -->
                    <div class="space-y-6">
                        <!-- Google OAuth -->
                        <div class="border rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <i class="fab fa-google text-2xl text-red-500"></i>
                                    <h3 class="font-semibold">Google OAuth</h3>
                                </div>
                                <span class="text-sm text-gray-500">Step 1 of 3</span>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-sm text-gray-600">Callback URL:</label>
                                    <div class="flex gap-2 mt-1">
                                        <input type="text" readonly id="google-callback-url"
                                               class="flex-1 p-2 bg-gray-50 border rounded font-mono text-sm"
                                               value="">
                                        <button onclick="copyToClipboard('google-callback-url')"
                                                class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2">
                                            <i class="fas fa-copy"></i>
                                            Copy
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-blue-50 p-3 rounded text-sm">
                                    <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                                    Add this URL to your Google Cloud Console OAuth 2.0 Client under "Authorized redirect URIs"
                                </div>
                            </div>
                        </div>

                        <!-- GitHub OAuth -->
                        <div class="border rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <i class="fab fa-github text-2xl"></i>
                                    <h3 class="font-semibold">GitHub OAuth</h3>
                                </div>
                                <span class="text-sm text-gray-500">Step 2 of 3</span>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-sm text-gray-600">Callback URL:</label>
                                    <div class="flex gap-2 mt-1">
                                        <input type="text" readonly id="github-callback-url"
                                               class="flex-1 p-2 bg-gray-50 border rounded font-mono text-sm"
                                               value="">
                                        <button onclick="copyToClipboard('github-callback-url')"
                                                class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2">
                                            <i class="fas fa-copy"></i>
                                            Copy
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded text-sm">
                                    <i class="fas fa-info-circle text-gray-600 mr-2"></i>
                                    Add this URL to your GitHub OAuth App settings under "Authorization callback URL"
                                </div>
                            </div>
                        </div>

                        <!-- Discord OAuth -->
                        <div class="border rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <i class="fab fa-discord text-2xl text-indigo-500"></i>
                                    <h3 class="font-semibold">Discord OAuth</h3>
                                </div>
                                <span class="text-sm text-gray-500">Step 3 of 3</span>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-sm text-gray-600">Redirect URL:</label>
                                    <div class="flex gap-2 mt-1">
                                        <input type="text" readonly id="discord-callback-url"
                                               class="flex-1 p-2 bg-gray-50 border rounded font-mono text-sm"
                                               value="">
                                        <button onclick="copyToClipboard('discord-callback-url')"
                                                class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2">
                                            <i class="fas fa-copy"></i>
                                            Copy
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-purple-50 p-3 rounded text-sm">
                                    <i class="fas fa-info-circle text-purple-600 mr-2"></i>
                                    Add this URL to your Discord Application OAuth2 settings under "Redirects"
                                </div>
                            </div>
                        </div>

                        <!-- Verification -->
                        <div class="bg-green-50 border-t-4 border-green-400 p-4 rounded">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-semibold text-green-900">Ready to verify?</h4>
                                    <p class="text-sm text-green-800 mt-1">Once you've configured all providers, click to verify the setup</p>
                                </div>
                                <button onclick="verifyOAuth(event)" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex items-center gap-2">
                                    <i class="fas fa-check-circle"></i>
                                    Verify OAuth
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Close Button -->
                    <div class="flex justify-end gap-3 mt-6">
                        <button onclick="hideOAuthModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include latest manager static files -->
    <script src="static/manager/manager.js"></script>
    <link rel="stylesheet" href="static/manager/styles.css">

    <!-- Override with mock data -->
    <script>
        // Mock data
        const agents = [
            { agent_id: 'datum', name: 'Datum', template: 'echo', status: 'running', container_name: 'ciris-agent-datum', api_port: 8081 },
            { agent_id: 'nexus', name: 'Nexus', template: 'discord', status: 'running', container_name: 'ciris-agent-nexus', api_port: 8082 },
            { agent_id: 'sage', name: 'Sage', template: 'wise', status: 'stopped', container_name: 'ciris-agent-sage', api_port: 8083 }
        ];

        // Helper function
        function escapeHtml(unsafe) {
            return unsafe
                ? unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;")
                : '';
        }

        // Render agents (from manager.js)
        function renderAgents() {
            const container = document.getElementById('agents-list');

            container.innerHTML = agents.map(agent => `
                <div class="border rounded-lg p-4 hover:bg-gray-50 transition-colors bg-white">
                    <div class="flex items-start justify-between">
                        <div class="space-y-1">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-server text-gray-600"></i>
                                <h3 class="font-semibold">${escapeHtml(agent.name || agent.agent_name)}</h3>
                                <span class="px-2 py-1 bg-gray-100 text-gray-700 text-sm rounded">
                                    ${escapeHtml(agent.template)}
                                </span>
                            </div>
                            <div class="text-sm text-gray-600 space-y-1">
                                <div>ID: ${escapeHtml(agent.agent_id)}</div>
                                <div>Container: ${escapeHtml(agent.container_name)}</div>
                                <div>Port: ${agent.api_port || agent.port}</div>
                                <div class="flex items-center gap-1">
                                    <span class="inline-block w-2 h-2 ${agent.status === 'running' ? 'bg-green-500' : 'bg-gray-400'} rounded-full"></span>
                                    ${agent.status || 'running'}
                                </div>
                            </div>
                        </div>
                        <div>
                            <button onclick="openAgentUI('${agent.agent_id}')" class="px-3 py-1 text-blue-600 hover:bg-blue-50 rounded">
                                <i class="fas fa-external-link-alt"></i> Open
                            </button>
                            <button onclick="showOAuthSetup('${agent.agent_id}')" class="px-3 py-1 text-purple-600 hover:bg-purple-50 rounded">
                                <i class="fas fa-cog"></i> Settings
                            </button>
                            <button onclick="deleteAgent('${agent.agent_id}')" class="px-3 py-1 text-red-600 hover:bg-red-50 rounded">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // OAuth modal functions (from manager.js)
        function showOAuthModal(agentId) {
            // Update agent ID in modal
            document.getElementById('oauth-agent-id').textContent = agentId;

            // Update callback URLs with actual agent ID
            const baseUrl = `https://agents.ciris.ai/v1/auth/oauth`;
            document.getElementById('google-callback-url').value = `${baseUrl}/${agentId}/google/callback`;
            document.getElementById('github-callback-url').value = `${baseUrl}/${agentId}/github/callback`;
            document.getElementById('discord-callback-url').value = `${baseUrl}/${agentId}/discord/callback`;

            // Show modal
            document.getElementById('oauth-setup-modal').classList.remove('hidden');

            console.log(`OAuth modal opened for agent: ${agentId}`);
        }

        function hideOAuthModal() {
            document.getElementById('oauth-setup-modal').classList.add('hidden');
        }

        function showOAuthSetup(agentId) {
            showOAuthModal(agentId);
        }

        // Copy to clipboard with visual feedback
        async function copyToClipboard(elementId) {
            const input = document.getElementById(elementId);
            const button = input.nextElementSibling;
            const originalHTML = button.innerHTML;

            try {
                await navigator.clipboard.writeText(input.value);

                // Show success feedback
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                button.classList.add('bg-green-600');

                // Reset after 2 seconds
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('bg-green-600');
                    button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            }
        }

        // Mock OAuth verification
        function verifyOAuth(event) {
            event.preventDefault();
            const button = event.target.closest('button');
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

            setTimeout(() => {
                button.innerHTML = '<i class="fas fa-check-circle"></i> Verified!';
                button.classList.remove('bg-green-600');
                button.classList.add('bg-green-700');
                console.log('OAuth verification would happen here in production');
            }, 1500);
        }

        // Mock functions for other buttons
        function openAgentUI(agentId) {
            console.log(`Open agent UI: ${agentId}`);
            alert(`Would open agent UI for: ${agentId}`);
        }

        function deleteAgent(agentId) {
            console.log(`Delete agent: ${agentId}`);
            alert(`Would delete agent: ${agentId}`);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            renderAgents();
            console.log('Test harness loaded. Click any Settings button to test OAuth modal.');
        });
    </script>
</body>
</html>
