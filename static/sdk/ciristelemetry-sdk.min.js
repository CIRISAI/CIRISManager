!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("axios")):"function"==typeof define&&define.amd?define(["axios"],t):"object"==typeof exports?exports.CIRISTelemetry=t(require("axios")):e.CIRISTelemetry=t(e.axios)}(this,e=>(()=>{"use strict";var t={120:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MonitoringAPI=void 0;const r=n(613);t.MonitoringAPI=class{constructor(e){this.axios=e}async getAllAgentsStatus(e){return(await this.axios.get("/telemetry/agents/current",{signal:e?.signal,timeout:e?.timeout})).data.agents}async getAllContainersStatus(e){return(await this.axios.get("/telemetry/containers/current",{signal:e?.signal,timeout:e?.timeout})).data.containers}async getAgentsByCognitiveState(e,t){return(await this.getAllAgentsStatus(t)).filter(t=>t.cognitive_state===e)}async getUnhealthyAgents(e){return(await this.getAllAgentsStatus(e)).filter(e=>!e.api_healthy)}async getContainersByHealth(e,t){return(await this.getAllContainersStatus(t)).filter(t=>t.health===e)}async getHighResourceContainers(e=80,t=80,n){return(await this.getAllContainersStatus(n)).filter(n=>n.resources.cpu_percent>e||n.resources.memory_percent>t)}async getAgentsWithIncidents(e=24,t){return(await this.getAllAgentsStatus(t)).filter(e=>e.incident_count_24h>0)}async getResourceSummary(e){return(await this.getAllContainersStatus(e)).reduce((e,t)=>({totalCpu:e.totalCpu+t.resources.cpu_percent,totalMemoryMb:e.totalMemoryMb+t.resources.memory_mb,totalDiskReadMb:e.totalDiskReadMb+t.resources.disk_read_mb,totalDiskWriteMb:e.totalDiskWriteMb+t.resources.disk_write_mb,totalNetworkRxMb:e.totalNetworkRxMb+t.resources.network_rx_mb,totalNetworkTxMb:e.totalNetworkTxMb+t.resources.network_tx_mb,containerCount:e.containerCount+1}),{totalCpu:0,totalMemoryMb:0,totalDiskReadMb:0,totalDiskWriteMb:0,totalNetworkRxMb:0,totalNetworkTxMb:0,containerCount:0})}async getCognitiveStateDistribution(e){const t=await this.getSystemSummary(e);return{[r.CognitiveState.WORK]:t.agents_in_work,[r.CognitiveState.DREAM]:t.agents_in_dream,[r.CognitiveState.SOLITUDE]:t.agents_in_solitude,[r.CognitiveState.PLAY]:t.agents_in_play,[r.CognitiveState.WAKEUP]:0,[r.CognitiveState.SHUTDOWN]:0,[r.CognitiveState.UNKNOWN]:0}}async getCostBreakdown(e){return(await this.getAllAgentsStatus(e)).map(e=>({agentId:e.agent_id,agentName:e.agent_name,costCents24h:e.cost_cents_24h,messageCount24h:e.message_count_24h,costPerMessage:e.message_count_24h>0?e.cost_cents_24h/e.message_count_24h:0})).sort((e,t)=>t.costCents24h-e.costCents24h)}async getSystemSummary(e){return(await this.axios.get("/telemetry/status",{signal:e?.signal,timeout:e?.timeout})).data}}},156:function(e,t,n){var r,a=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,a)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||a(t,e,n)},o=this&&this.__importStar||(r=function(e){return r=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},r(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=r(e),i=0;i<n.length;i++)"default"!==n[i]&&a(t,e,n[i]);return s(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.VERSION=t.AnalyticsAPI=t.MonitoringAPI=t.createTelemetryClient=t.CIRISTelemetryClient=void 0,t.quickStart=function(e,t){const r=(0,c.createTelemetryClient)(e,t);return{client:r,getHealth:async()=>r.getHealth(),getStatus:async()=>r.getStatus(),getPublicStatus:async()=>r.getPublicStatus(),triggerCollection:async()=>r.triggerCollection(),monitoring:{getUnhealthyAgents:async()=>new((await Promise.resolve().then(()=>o(n(120)))).MonitoringAPI)(r.axios).getUnhealthyAgents(),getHighResourceContainers:async(e=80,t=80)=>new((await Promise.resolve().then(()=>o(n(120)))).MonitoringAPI)(r.axios).getHighResourceContainers(e,t),getCostBreakdown:async()=>new((await Promise.resolve().then(()=>o(n(120)))).MonitoringAPI)(r.axios).getCostBreakdown()},analytics:{detectAnomalies:async(e=1)=>new((await Promise.resolve().then(()=>o(n(316)))).AnalyticsAPI)(r.axios).detectAnomalies(e),predictResourceUsage:async(e=24)=>new((await Promise.resolve().then(()=>o(n(316)))).AnalyticsAPI)(r.axios).predictResourceUsage(e),analyzeTrend:async(e,t=24)=>new((await Promise.resolve().then(()=>o(n(316)))).AnalyticsAPI)(r.axios).analyzeTrend(e,t)}}};const c=n(985);Object.defineProperty(t,"CIRISTelemetryClient",{enumerable:!0,get:function(){return c.CIRISTelemetryClient}}),Object.defineProperty(t,"createTelemetryClient",{enumerable:!0,get:function(){return c.createTelemetryClient}});var u=n(120);Object.defineProperty(t,"MonitoringAPI",{enumerable:!0,get:function(){return u.MonitoringAPI}});var l=n(316);Object.defineProperty(t,"AnalyticsAPI",{enumerable:!0,get:function(){return l.AnalyticsAPI}}),i(n(613),t),t.VERSION="1.0.0",t.default=c.CIRISTelemetryClient},316:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.AnalyticsAPI=void 0,t.AnalyticsAPI=class{constructor(e){this.axios=e}async analyzeTrend(e,t=24,n){const r={query_type:"timeseries",metric_name:e,time_range:{start:new Date(Date.now()-36e5*t).toISOString(),end:(new Date).toISOString()},interval:t<=24?"1h":"1d"},a=(await this.executeQuery(r,n)).data;if(a.length<2)return{metric:e,trend:"stable",changePercent:0,currentValue:a[0]?.value||0,previousValue:a[0]?.value||0,timeRange:`${t}h`};const s=a[a.length-1].value,i=a[0].value,o=(s-i)/i*100;return{metric:e,trend:o>5?"increasing":o<-5?"decreasing":"stable",changePercent:o,currentValue:s,previousValue:i,timeRange:`${t}h`}}async detectAnomalies(e=1,t){const n=[],r={query_type:"distribution",metric_name:"cpu_percent",time_range:{start:new Date(Date.now()-36e5*e).toISOString(),end:(new Date).toISOString()}},a=(await this.executeQuery(r,t)).data,s=a.map(e=>e.value),i=s.reduce((e,t)=>e+t,0)/s.length,o=Math.sqrt(s.reduce((e,t)=>e+Math.pow(t-i,2),0)/s.length);a.forEach(e=>{Math.abs(e.value-i)>3*o&&n.push({metric:"cpu_percent",value:e.value,expectedRange:{min:Math.max(0,i-2*o),max:i+2*o},severity:Math.abs(e.value-i)>4*o?"high":"medium",timestamp:e.timestamp,entity:e.entity||"unknown"})});const c={query_type:"distribution",metric_name:"memory_percent",time_range:{start:new Date(Date.now()-36e5*e).toISOString(),end:(new Date).toISOString()}};return(await this.executeQuery(c,t)).data.forEach(e=>{e.value>90&&n.push({metric:"memory_percent",value:e.value,expectedRange:{min:0,max:90},severity:e.value>95?"high":"medium",timestamp:e.timestamp,entity:e.entity||"unknown"})}),n}async calculateBaselines(e,t=7,n){const r=[];for(const a of e){const e={query_type:"aggregate",metric_name:a,time_range:{start:new Date(Date.now()-864e5*t).toISOString(),end:(new Date).toISOString()},aggregation:"avg"},s=(await this.executeQuery(e,n)).data.map(e=>e.value).sort((e,t)=>e-t);if(0===s.length)continue;const i=s.reduce((e,t)=>e+t,0)/s.length,o=s[Math.floor(s.length/2)],c=Math.sqrt(s.reduce((e,t)=>e+Math.pow(t-i,2),0)/s.length),u=s[Math.floor(.95*s.length)],l=s[Math.floor(.99*s.length)];r.push({metric:a,mean:i,median:o,stdDev:c,p95:u,p99:l,samples:s.length})}return r}async analyzeAgentPerformance(e,t=7,n){const r=24*t,a=(await this.axios.get(`/telemetry/agent/${e}`,{params:{hours:r},signal:n?.signal,timeout:n?.timeout})).data.history,s=a.length,i=a.filter(e=>e.api_healthy).length/s*100,o=a.map(e=>e.api_response_time_ms||0),c=o.reduce((e,t)=>e+t,0)/o.length,u=a.reduce((e,t)=>e+(t.message_count_24h||0),0),l=a.reduce((e,t)=>e+(t.cost_cents_24h||0),0),h=a.reduce((e,t)=>e+(t.incident_count_24h||0),0),g=u>0?h/u*100:0,d=[],y=await this.analyzeTrend(`agent.${e}.response_time`,r,n);d.push(y);const m=await this.analyzeTrend(`agent.${e}.messages`,r,n);d.push(m);const p=await this.analyzeTrend(`agent.${e}.cost`,r,n);return d.push(p),{availability:i,averageResponseTime:c,totalMessages:u,totalCost:l,incidentRate:g,trends:d}}async compareAgents(e,t,n=24,r){const a=[];for(const s of e){const e={query_type:"aggregate",metric_name:`agent.${s}.${t}`,time_range:{start:new Date(Date.now()-36e5*n).toISOString(),end:(new Date).toISOString()},aggregation:"avg"},i=await this.executeQuery(e,r),o=i.data[0]?.value||0;a.push({agentName:s,value:o})}return a.sort((e,t)=>t.value-e.value),a.map((e,t)=>({...e,rank:t+1,percentile:(a.length-t)/a.length*100}))}async predictResourceUsage(e=24,t){const n=await this.analyzeTrend("total_cpu_percent",2*e,t),r=await this.analyzeTrend("total_memory_mb",2*e,t),a=n.changePercent/100,s=r.changePercent/100,i=n.currentValue*(1+a),o=r.currentValue*(1+s);let c="";return c=i>80?"Consider scaling up CPU resources":o>13107.2?"Consider scaling up memory resources":i<20&&o<3276.8?"Resources are underutilized, consider scaling down":"Resource usage is within normal parameters",{predictedCpu:i,predictedMemory:o,confidence:"stable"===n.trend&&"stable"===r.trend?.9:n.trend===r.trend?.7:.5,recommendation:c}}async executeQuery(e,t){return(await this.axios.post("/telemetry/query",e,{signal:t?.signal,timeout:t?.timeout})).data}}},613:(e,t)=>{var n,r,a,s,i,o;Object.defineProperty(t,"__esModule",{value:!0}),t.StorageError=t.CollectionError=t.TelemetryError=t.ComponentType=t.DeploymentPhase=t.DeploymentStatus=t.CognitiveState=t.HealthStatus=t.ContainerStatus=void 0,function(e){e.RUNNING="running",e.STOPPED="stopped",e.RESTARTING="restarting",e.PAUSED="paused",e.EXITED="exited",e.DEAD="dead",e.CREATED="created",e.REMOVING="removing",e.UNKNOWN="unknown"}(n||(t.ContainerStatus=n={})),function(e){e.HEALTHY="healthy",e.UNHEALTHY="unhealthy",e.STARTING="starting",e.NONE="none",e.UNKNOWN="unknown"}(r||(t.HealthStatus=r={})),function(e){e.WAKEUP="WAKEUP",e.WORK="WORK",e.PLAY="PLAY",e.SOLITUDE="SOLITUDE",e.DREAM="DREAM",e.SHUTDOWN="SHUTDOWN",e.UNKNOWN="unknown"}(a||(t.CognitiveState=a={})),function(e){e.PENDING="pending",e.IN_PROGRESS="in_progress",e.PAUSED="paused",e.COMPLETED="completed",e.FAILED="failed",e.CANCELLED="cancelled",e.REJECTED="rejected",e.ROLLING_BACK="rolling_back",e.ROLLED_BACK="rolled_back",e.STAGED="staged"}(s||(t.DeploymentStatus=s={})),function(e){e.EXPLORERS="explorers",e.EARLY_ADOPTERS="early_adopters",e.GENERAL="general",e.COMPLETE="complete"}(i||(t.DeploymentPhase=i={})),function(e){e.AGENT="agent",e.GUI="gui",e.NGINX="nginx",e.MANAGER="manager"}(o||(t.ComponentType=o={}));class c extends Error{constructor(e,t,n){super(e),this.statusCode=t,this.details=n,this.name="TelemetryError"}}t.TelemetryError=c,t.CollectionError=class extends c{constructor(e,t){super(e,503,t),this.name="CollectionError"}},t.StorageError=class extends c{constructor(e,t){super(e,500,t),this.name="StorageError"}}},674:t=>{t.exports=e},985:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,a)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CIRISTelemetryClient=void 0,t.createTelemetryClient=function(e,t){return new c({baseUrl:e,apiKey:t,timeout:3e4,retryAttempts:3,retryDelay:1e3,enableCache:!0,cacheTimeout:6e4})};const i=s(n(674)),o=n(613);class c{constructor(e){this.options=e,this.wsSubscriptions=new Map,this.wsReconnectAttempts=0,this.wsMaxReconnectAttempts=5,this.wsReconnectDelay=1e3,this.cache=new Map,this.axios=i.default.create({baseURL:e.baseUrl,timeout:e.timeout||3e4,headers:{"Content-Type":"application/json",...e.apiKey&&{Authorization:`Bearer ${e.apiKey}`}}}),this.axios.interceptors.response.use(e=>e,this.handleAxiosError.bind(this)),e.enableCache&&setInterval(()=>this.cleanupCache(),6e4)}async getHealth(e){return await this.request("GET","/telemetry/health",void 0,e)}async getStatus(e){const t="status",n=this.getCached(t);if(n)return n;const r=await this.request("GET","/telemetry/status",void 0,e);return this.setCache(t,r,5e3),r}async getOrchestratorStats(e){return await this.request("GET","/telemetry/orchestrator/stats",void 0,e)}async getHistory(e=24,t="5m",n){const r={hours:e,interval:t},a=`history_${e}_${t}`,s=this.getCached(a);if(s)return s;const i=await this.request("GET","/telemetry/history",{params:r},n);return this.setCache(a,i,6e4),i}async getAgentMetrics(e,t,n){const r=t?{hours:t}:void 0;return await this.request("GET",`/telemetry/agent/${e}`,{params:r},n)}async getContainerMetrics(e,t,n){const r=t?{hours:t}:void 0;return await this.request("GET",`/telemetry/container/${e}`,{params:r},n)}async getPublicStatus(e){const t="public_status",n=this.getCached(t);if(n)return n;const r=await this.request("GET","/telemetry/public/status",void 0,e);return this.setCache(t,r,3e4),r}async getPublicHistory(e=24,t=5,n){const r={hours:e,interval:t},a=`public_history_${e}_${t}`,s=this.getCached(a);if(s)return s;const i=await this.request("GET","/telemetry/public/history",{params:r},n);return this.setCache(a,i,6e4),i}async query(e,t){return await this.request("POST","/telemetry/query",{data:e},t)}async getSnapshot(e){return await this.request("GET","/telemetry/snapshot",void 0,e)}async triggerCollection(e){const t=await this.request("POST","/telemetry/collect",void 0,e);return this.clearCache(),t}async cleanupOldData(e=30,t){return await this.request("POST","/telemetry/cleanup",{data:{days_to_keep:e}},t)}connectWebSocket(e,t){if(this.wsConnection?.readyState===WebSocket.OPEN)return;const n=this.options.baseUrl.replace(/^http/,"ws")+"/telemetry/ws";try{this.wsConnection=new WebSocket(n),this.wsConnection.onopen=()=>{console.log("Telemetry WebSocket connected"),this.wsReconnectAttempts=0,this.wsSubscriptions.forEach(e=>{this.wsConnection?.send(JSON.stringify({type:"subscribe",subscription:e}))})},this.wsConnection.onmessage=t=>{try{const n=JSON.parse(t.data);e(n)}catch(e){console.error("Failed to parse WebSocket message:",e)}},this.wsConnection.onerror=e=>{console.error("Telemetry WebSocket error:",e),t?.(new Error("WebSocket error"))},this.wsConnection.onclose=()=>{console.log("Telemetry WebSocket disconnected"),this.handleWebSocketReconnect(e,t)}}catch(e){console.error("Failed to connect WebSocket:",e),t?.(e)}}subscribe(e){if(!this.wsConnection||this.wsConnection.readyState!==WebSocket.OPEN)throw new Error("WebSocket not connected");this.wsSubscriptions.set(e.id,e),this.wsConnection.send(JSON.stringify({type:"subscribe",subscription:e}))}unsubscribe(e){this.wsConnection&&this.wsConnection.readyState===WebSocket.OPEN&&(this.wsSubscriptions.delete(e),this.wsConnection.send(JSON.stringify({type:"unsubscribe",subscriptionId:e})))}disconnectWebSocket(){this.wsConnection&&(this.wsConnection.close(),this.wsConnection=void 0,this.wsSubscriptions.clear())}clearCache(){this.cache.clear()}setBaseUrl(e){this.options.baseUrl=e,this.axios.defaults.baseURL=e}setApiKey(e){this.options.apiKey=e,this.axios.defaults.headers.Authorization=`Bearer ${e}`}async request(e,t,n,r){try{return(await this.axios.request({method:e,url:t,...n,...r&&{signal:r.signal,timeout:r.timeout||this.options.timeout,headers:{...n?.headers,...r.headers}}})).data}catch(e){throw this.handleError(e)}}handleAxiosError(e){if(503===e.response?.status)throw new o.CollectionError("Telemetry service unavailable",e.response.data);if(500===e.response?.status)throw new o.StorageError("Telemetry storage error",e.response.data);throw e}handleError(e){if(i.default.isAxiosError(e)){const t=e.response?.data?.detail||e.message;return new o.TelemetryError(t,e.response?.status,e.response?.data)}return e}getCached(e){if(!this.options.enableCache)return null;const t=this.cache.get(e);return t&&t.expiry>Date.now()?t.data:(this.cache.delete(e),null)}setCache(e,t,n){if(!this.options.enableCache)return;const r=Date.now()+(n||this.options.cacheTimeout||6e4);this.cache.set(e,{data:t,expiry:r})}cleanupCache(){const e=Date.now();for(const[t,n]of this.cache.entries())n.expiry<=e&&this.cache.delete(t)}handleWebSocketReconnect(e,t){if(this.wsReconnectAttempts>=this.wsMaxReconnectAttempts)return console.error("Max WebSocket reconnection attempts reached"),void t?.(new Error("Max reconnection attempts reached"));this.wsReconnectAttempts++;const n=this.wsReconnectDelay*Math.pow(2,this.wsReconnectAttempts-1);console.log(`Attempting WebSocket reconnection in ${n}ms...`),setTimeout(()=>{this.connectWebSocket(e,t)},n)}}t.CIRISTelemetryClient=c,a(n(613),t)}},n={},r=function e(r){var a=n[r];if(void 0!==a)return a.exports;var s=n[r]={exports:{}};return t[r].call(s.exports,s,s.exports,e),s.exports}(156);return r.default})());